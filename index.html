<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ATOMIC FIZZ • VAULT 77 • WASTELAND GPS</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<style>
* {margin:0;padding:0;box-sizing:border-box}
html,body {height:100%;background:#000;overflow:hidden;font-family:"Courier New",monospace;color:#00ff00;text-shadow:0 0 6px #00ff00}
body {background:radial-gradient(circle at center,#002200,#000)}
.crt::before {content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,0,0.08) 0px,transparent 2px);pointer-events:none;animation:scan 7s linear infinite}
@keyframes scan {0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
.pipboy {position:fixed;inset:0;background:#001100;padding:10px;box-shadow:0 0 140px #00ff00,inset 0 0 180px rgba(0,0,0,0.9)}
.pip-screen {position:absolute;inset:10px;background:#000;overflow-y:auto;padding:18px;border-radius:18px;box-shadow:inset 0 0 90px #003300}
h1{font-size:2.5rem;text-align:center;letter-spacing:8px;background:linear-gradient(90deg,#00ff00,#44ff44);-webkit-background-clip:text;color:transparent;animation:glow 2s infinite}
@keyframes glow{0%,100%{text-shadow:0 0 40px #00ff00}50%{text-shadow:0 0 100px #00ff00}}
.statbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:10px;margin:20px 0}
.stat{background:#000;border:4px ridge #00aa00;padding:10px;text-align:center;border-radius:10px}
.val{font-size:2rem;color:#ffff00;text-shadow:0 0 15px #ffff00}
.btn{background:#000;color:#00ff00;border:4px ridge #00aa00;padding:14px 28px;margin:10px;border-radius:24px;cursor:pointer;font-weight:bold}
.btn:hover{background:rgba(0,255,0,0.3);box-shadow:0 0 60px #00ff00;transform:scale(1.07)}
#map-container {height:380px;margin:22px 0;border:7px ridge #00ff00;border-radius:20px;overflow:hidden;position:relative}
#map {width:100%;height:100%;filter:hue-rotate(90deg) saturate(2) brightness(1.2)}
.tabs{display:flex;justify-content:center;gap:12px;margin:20px 0}
.tab{background:rgba(0,0,0,0.8);border:3px ridge #00aa00;padding:12px 24px;border-radius:24px;cursor:pointer}
.tab.active,.tab:hover{background:#00ff00;color:#000}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin:12px 0}
.item{background:rgba(0,30,0,0.9);border:4px ridge #00aa00;padding:16px;border-radius:12px}
.rar{padding:8px 16px;border-radius:24px;margin-top:10px;display:inline-block}
.legendary{background:#ffff00;color:#000;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 20px #ffff00}50%{box-shadow:0 0 60px #00ff00}}
.epic{background:#ff6200;color:#000}.rare{background:#00ffff;color:#000}.common{background:#006600;color:#0f0}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://unpkg.com/@solana/wallet-adapter-phantom@latest"></script>
</head>
<body class="crt">
<div class="pipboy">
  <div class="pip-screen">
    <h1>ATOMIC FIZZ</h1>
    <p style="text-align:center;letter-spacing:5px">VAULT 77 • GPS • WASTELAND</p>
    
    <div class="statbar">
      <div class="stat"><div class="val" id="lvl">1</div><div>LEVEL</div></div>
      <div class="stat"><div class="val" id="hp">100/100</div><div>HP</div></div>
      <div class="stat"><div class="val" id="caps">0</div><div>CAPS</div></div>
      <div class="stat"><div class="val" id="claimed">0</div><div>CLAIMED</div></div>
    </div>

    <button class="btn" id="connectBtn">CONNECT PHANTOM</button>
    <div id="status" style="text-align:center;margin:12px;color:#f66;font-size:1.4rem">NOT CONNECTED</div>

    <div id="map-container">
      <div id="map"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="map">SCANNER</button>
      <button class="tab" data-tab="inventory">INVENTORY</button>
    </div>

    <div class="grid" id="grid" style="display:none"></div>
  </div>
</div>

<script>
// AUTO DETECT API
const API_BASE = window.location.origin;

let map, playerMarker, wallet, player = {lvl:1,hp:100,maxHp:100,caps:0,gear:[],claimed:[]}, markers = {}, claimed = new Set();

async function connectWallet() {
    try {
        const provider = window.solana;
        if (!provider?.isPhantom) return alert("Phantom not found!");
        await provider.connect();
        wallet = provider;
        document.getElementById('status').textContent = "CONNECTED: " + provider.publicKey.toBase58().slice(0,8) + "...";
        document.getElementById('connectBtn').textContent = "CONNECTED";
        loadPlayer();
    } catch(e) { alert("Connection failed"); }
}

async function loadPlayer() {
    if (!wallet) return;
    const res = await fetch(`${API_BASE}/locations`);
    if (res.ok) initMap(await res.json());
}

async function claimLoot(loc) {
    if (!wallet) return alert("Connect wallet!");
    if (player.lvl < loc.lvl) return alert(`Need Level ${loc.lvl}`);
    if (claimed.has(loc.n)) return alert("Already looted!");

    try {
        const res = await fetch(`${API_BASE}/claim-survival`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ wallet: wallet.publicKey.toBase58(), spot: loc.n })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || "Failed");

        player.caps += 25;
        if (data.gear) player.gear.push(data.gear);
        player.lvl = data.lvl || player.lvl;
        claimed.add(loc.n);
        markers[loc.n].setStyle({fillColor: '#003300'});
        updateUI();
        alert(data.message);
    } catch(e) { alert("Claim failed: " + e.message); }
}

function initMap(locations) {
    map = L.map('map').setView([36.1146, -115.1728], 10);
    L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);

    playerMarker = L.circleMarker([36.1146, -115.1728], {radius:22,color:'#000',weight:7,fillColor:'#00ff00',fillOpacity:1})
        .addTo(map).bindPopup("YOU ARE HERE").openPopup();

    locations.forEach(loc => {
        const color = loc.rarity === 'legendary' ? '#ffff00' : loc.rarity === 'epic' ? '#ff6200' : loc.rarity === 'rare' ? '#00ffff' : '#00ff00';
        const m = L.circleMarker([loc.lat, loc.lng], {radius:18,color:'#000',weight:6,fillColor:color,fillOpacity:0.95})
            .bindPopup(`<b>${loc.n}</b><br><span class="rar ${loc.rarity}">${loc.rarity.toUpperCase()}</span><br>Level ${loc.lvl}`)
            .on('click', () => claimLoot(loc))
            .addTo(map);
        markers[loc.n] = m;
    });

    if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(pos => {
            playerMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
            map.panTo([pos.coords.latitude, pos.coords.longitude]);
        }, null, {enableHighAccuracy:true});
    }
}

function updateUI() {
    document.getElementById('lvl').textContent = player.lvl;
    document.getElementById('hp').textContent = `${player.hp}/${player.maxHp}`;
    document.getElementById('caps').textContent = player.caps;
    document.getElementById('claimed').textContent = claimed.size;
}

document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const mode = t.dataset.tab;
    document.getElementById('map-container').style.display = mode === 'map' ? 'block' : 'none';
    document.getElementById('grid').style.display = mode === 'map' ? 'none' : 'grid';
    if (mode === 'inventory') {
        document.getElementById('grid').innerHTML = player.gear.map(g => `<div class="item">• ${g.name} <span class="rar ${g.rarity}">${g.rarity}</span></div>`).join('') || "<div class='item'>No gear yet</div>";
    }
});

document.getElementById('connectBtn').onclick = connectWallet;
</script>
</body>
</html>
