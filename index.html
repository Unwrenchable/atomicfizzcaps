<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PIP-BOY 3000 Mk IV • ATOMIC FIZZ • VAULT 77</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#001100">
<style>
* {margin:0;padding:0;box-sizing:border-box}
html,body {height:100%;background:#000;overflow:hidden;font-family:"Courier New",monospace;color:#00ff00;font-weight:bold;text-shadow:0 0 5px #00ff00}
body {background:radial-gradient(circle at center,#001100,#000)}
.crt::before {content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,0,0.03) 0px,transparent 1px,transparent 2px);pointer-events:none;animation:scan 10s linear infinite}
.crt::after {content:"";position:fixed;inset:0;background:linear-gradient(0deg,transparent 0%,rgba(0,0,0,0.3) 50%,transparent 100%);pointer-events:none}
@keyframes scan {0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
.pipboy {position:fixed;inset:0;background:linear-gradient(145deg,#001100,#000);box-shadow:0 0 100px #00ff00,0 0 200px #00aa00,inset 0 0 150px rgba(0,0,0,0.9);padding:10px}
.pip-screen {position:absolute;inset:10px;background:#000;overflow-y:auto;box-shadow:inset 0 0 60px #002200,0 0 60px rgba(0,255,0,0.6);padding:15px;border-radius:15px}
.pip-screen{overflow-y:scroll;-ms-overflow-style:none;scrollbar-width:none} .pip-screen::-webkit-scrollbar{display:none}
h1{font-size:2.4rem;text-align:center;margin:8px 0;letter-spacing:6px;background:linear-gradient(90deg,#00ff00,#44ff44,#00ff00);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 30px #00ff00;animation:glow 2s ease-in-out infinite}
@keyframes glow{0%,100%{text-shadow:0 0 30px #00ff00}50%{text-shadow:0 0 60px #00ff00,0 0 120px #00ff00}}
.statbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin:15px 0}
.stat{background:#000;border:3px double #00aa00;padding:8px;text-align:center;border-radius:8px;box-shadow:0 0 15px rgba(0,255,0,0.5)}
.val{font-size:1.8rem;color:#ffff00;text-shadow:0 0 10px #ffff00;font-weight:900}
.btn{background:#000;color:#00ff00;border:3px double #00aa00;padding:12px 24px;margin:8px;border-radius:20px;cursor:pointer;font-weight:bold;transition:.2s;box-shadow:0 0 10px #00ff00}
.btn:hover,.btn:active{background:rgba(0,255,0,0.2);box-shadow:0 0 40px #00ff00;transform:scale(1.05)}
#map{height:320px;border:5px double #00aa00;border-radius:12px;margin:20px 0;box-shadow:0 0 40px #00ff00,inset 0 0 30px #000;background:#000}
.tabs{display:flex;justify-content:center;gap:10px;margin:15px 0;flex-wrap:wrap}
.tab{background:rgba(0,0,0,0.7);border:2px double #00aa00;padding:10px 18px;border-radius:20px;cursor:pointer;transition:.2s}
.tab.active,.tab:hover{background:#00aa00;color:#000;box-shadow:0 0 20px #00ff00}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin:10px 0}
.item{background:rgba(0,20,0,0.8);border:3px double #00aa00;padding:14px;border-radius:10px;transition:.3s;box-shadow:0 0 10px rgba(0,255,0,0.4)}
.item:hover{transform:translateY(-6px);box-shadow:0 0 40px #00ff00;background:rgba(0,255,0,0.15)}
.rar{padding:6px 14px;border-radius:20px;font-size:0.9rem;margin-top:8px;display:inline-block;font-weight:bold}
.legendary{background:#ffff00;color:#000;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 15px #ffff00}50%{box-shadow:0 0 40px #00ff00}}
.epic{background:#ff6600;color:#000}.rare{background:#00ffff;color:#000}.common{background:#006600;color:#0f0}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:9999;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px;color:#0f0}
.crate{width:340px;height:340px;background:#111 url('https://i.ibb.co/4p7vK3B/nuka-crate.png') center/70% no-repeat;border:10px solid #ff6200;border-radius:25px;display:flex;align-items:flex-end;justify-content:center;font-size:5rem;color:#ff6200;text-shadow:0 0 30px #f90;animation:shake 0.7s infinite}
@keyframes shake{0%,100%{transform:translate(0)}25%{transform:translate(-15px,15px)rotate(-8deg)}75%{transform:translate(15px,-15px)rotate(8deg)}}
.you-popup .leaflet-popup-content-wrapper,.you-popup .leaflet-popup-tip{background:transparent !important;box-shadow:none !important;border:none !important}
.you-popup .leaflet-popup-content{color:#0ff;font-weight:bold;text-shadow:0 0 15px #0ff;margin:0;padding:0}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body class="crt">
<div class="pipboy">
  <div class="pip-screen">
    <h1>ATOMIC FIZZ</h1>
    <p style="text-align:center;letter-spacing:4px;margin-bottom:15px">VAULT 77 • REAL GPS • MOJAVE WASTELAND</p>
    
    <div class="statbar">
      <div class="stat"><div class="val" id="lvl">1</div><div>LEVEL</div></div>
      <div class="stat"><div class="val" id="hp">100/100</div><div>HP</div></div>
      <div class="stat"><div class="val" id="caps">0</div><div>CAPS</div></div>
      <div class="stat"><div class="val" id="stimpaks">0</div><div>STIMPAKS</div></div>
      <div class="stat"><div class="val" id="claimed">0</div><div>CLAIMED</div></div>
    </div>

    <button class="btn" id="connectBtn" onclick="connectWallet()">CONNECT WALLET</button>
    <div id="status" style="text-align:center;margin:10px;font-size:1.3rem;color:#f66">NOT CONNECTED</div>

    <div id="map"></div>

    <div class="tabs">
      <button class="tab active" data-tab="map">SCANNER</button>
      <button class="tab" data-tab="inventory">INVENTORY</button>
      <button class="tab" data-tab="quest">QUEST LOG</button>
    </div>

    <div class="grid" id="grid" style="display:none"></div>
  </div>
</div>

<div class="overlay" id="lootOverlay" style="display:none">
  <div class="crate">LOOT</div>
  <h2 id="lootMsg" style="margin:30px;font-size:2.5rem;"></h2>
  <button class="btn" onclick="closeLoot()">CLAIM & CONTINUE</button>
</div>

<div class="overlay" id="combatOverlay" style="display:none; background:#300;border:8px double #f66;padding:40px">
  <h2 style="color:#f66;font-size:3rem" id="enemyName">DEATHCLAW</h2>
  <p style="font-size:2rem" id="enemyHp">HP: 250</p>
  <button class="btn" style="background:#f66;color:#000" onclick="fight()">V.A.T.S. ATTACK</button>
  <button class="btn" onclick="flee()">FLEE</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Globals
let map, playerMarker, watchId;
let player = { lvl: 1, hp: 100, maxHp: 100, caps: 0, stimpaks: [], gear: [], lat: 36.1146, lng: -115.1728 };
let claimed = new Set();
let markers = {};
let wallet = null;
let currentEnemy = null;
const API_BASE = 'http://localhost:3000'; // Change to your Vercel URL

// Audio (use your hosted files to avoid CORS)
const lootSound = new Audio('https://freesound.org/data/previews/571/571551_12117998-lq.mp3');
const hitSound = new Audio('https://freesound.org/data/previews/276/276481_4043684-lq.mp3');
const deathSound = new Audio('https://freesound.org/data/previews/249/249522_4397579-lq.mp3');

// Wallet connect
async function connectWallet() {
  if (window.solana) {
    try {
      wallet = await window.solana.connect();
      document.getElementById('status').textContent = 'CONNECTED';
      document.getElementById('connectBtn').disabled = true;
      await loadPlayer();
    } catch (e) { alert('Connection failed: ' + e.message); }
  } else alert('Install Phantom: https://phantom.app');
}

// Load player
async function loadPlayer() {
  if (!wallet?.publicKey) return;
  try {
    const res = await fetch(`${API_BASE}/player/${wallet.publicKey.toString()}`);
    if (!res.ok) throw new Error('Fetch failed - is backend running?');
    const data = await res.json();
    player.caps = data.caps || 0;
    player.hp = data.hp || 100;
    player.gear = data.gear || [];
    player.stimpaks = data.stimpaks || [];
    player.maxHp = 100 + (Math.floor(player.caps / 1000) * 50);
    player.lvl = Math.floor(player.caps / 1000) + 1;
    updateUI();
  } catch (e) { console.error(e); alert('Load failed—check console and backend'); }
}

// Claim loot
async function claimLoot(loc) {
  if (claimed.has(loc.n) || player.lvl < loc.lvl) {
    alert(player.lvl < loc.lvl ? `LEVEL ${loc.lvl} REQUIRED!` : 'Already claimed');
    return;
  }
  if (!wallet?.publicKey) return alert('Connect wallet!');
  try {
    const res = await fetch(`${API_BASE}/claim-survival`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wallet: wallet.publicKey.toString(), spot: loc.n })
    });
    if (!res.ok) throw new Error('Claim failed - check backend');
    const data = await res.json();
    claimed.add(loc.n);
    player.caps += data.caps;
    if (data.gear) player.gear.push(data.gear);
    if (data.raid) {
      player.hp = data.raid.hp;
      player.gear = data.raid.gear;
      currentEnemy = { name: data.raid.enemy, hp: 0 };
      document.getElementById('enemyName').textContent = data.raid.enemy;
      document.getElementById('enemyHp').textContent = 'DEFEATED';
      document.getElementById('combatOverlay').style.display = 'flex';
      if (data.raid.revived) alert(`Revived with ${data.raid.stimpakUsed}!`);
      else if (!data.raid.won) die();
    } else {
      let msg = data.message + '<br>+25 CAPS';
      if (data.gear) msg += `<br><span class="rar ${data.gear.rarity}">Got ${data.gear.rarity.toUpperCase()} ${data.gear.name}!</span>`;
      document.getElementById('lootMsg').innerHTML = msg;
      document.getElementById('lootOverlay').style.display = 'flex';
      lootSound.play().catch((e) => console.error('Audio fail: ' + e));
    }
    const oldLvl = player.lvl;
    player.lvl = Math.floor(player.caps / 1000) + 1;
    if (player.lvl > oldLvl) {
      player.maxHp += 50;
      player.hp = player.maxHp;
    }
    markers[loc.n].setStyle({ fillColor: '#003300' });
    updateUI();
  } catch (e) { alert(`Error: ${e.message} - Check console`); }
}

// Buy stimpak
async function buyStimpak(tier, cost) {
  if (!wallet?.publicKey) return alert('Connect wallet!');
  if (player.caps < cost) return alert('Not enough CAPS!');
  try {
    const res = await fetch(`${API_BASE}/buy-stimpak`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wallet: wallet.publicKey.toString(), tier, cost })
    });
    if (!res.ok) throw new Error('Buy failed');
    const data = await res.json();
    player.stimpaks.push({ name: data.stimpak, tier });
    player.caps -= cost;
    updateUI();
    alert(`Bought ${data.stimpak}! Cooldown: ${data.cooldown}`);
  } catch (e) { alert(`Error: ${e.message}`); }
}

// Combat
function fight() {
  hitSound.play().catch(() => {});
  document.getElementById('combatOverlay').style.display = 'none';
  alert('Battle resolved!');
}

function flee() {
  document.getElementById('combatOverlay').style.display = 'none';
  alert('Escaped!');
}

function die() {
  deathSound.play().catch(() => {});
  player.caps = Math.floor(player.caps * 0.5);
  player.hp = player.maxHp;
  alert('YOU DIED — Lost 50% CAPS');
  document.getElementById('combatOverlay').style.display = 'none';
  updateUI();
}

function closeLoot() {
  document.getElementById('lootOverlay').style.display = 'none';
}

function updateUI() {
  document.getElementById('lvl').textContent = player.lvl || 1;
  document.getElementById('hp').textContent = `${player.hp}/${player.maxHp}`;
  document.getElementById('caps').textContent = player.caps || 0;
  document.getElementById('stimpaks').textContent = player.stimpaks.length || 0;
  document.getElementById('claimed').textContent = claimed.size || 0;
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const mode = tab.dataset.tab;
    document.getElementById('map').style.display = mode === 'map' ? 'block' : 'none';
    document.getElementById('grid').style.display = mode === 'map' ? 'none' : 'grid';
    if (mode === 'inventory') {
      let html = player.gear.length ? player.gear.map(g => `<div class="item">• ${g.name} (${g.rarity})</div>`).join('') : '<div class="item">Inventory Empty</div>';
      html += '<div class="item">Stimpaks: ' + player.stimpaks.length + '</div>';
      html += '<button class="btn" onclick="buyStimpak(\'common\', 50)">Buy Stimpak (50 CAPS)</button>';
      html += '<button class="btn" onclick="buyStimpak(\'rare\', 150)">Buy Super Stimpak (150 CAPS)</button>';
      html += '<button class="btn" onclick="buyStimpak(\'legendary\', 500)">Buy Med-X + Stimpak (500 CAPS)</button>';
      document.getElementById('grid').innerHTML = html;
    }
    if (mode === 'quest') document.getElementById('grid').innerHTML = '<div class="item">Main Quest: Reach Vault 77</div>';
  };
});

// Map init
async function initMap() {
  if (typeof L === 'undefined') return console.error('Leaflet not loaded');
  map = L.map('map', { zoomControl: true }).setView([36.1146, -115.1728], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap', maxZoom: 19
  }).addTo(map);
  playerMarker = L.circleMarker([player.lat, player.lng], { radius: 18, color: '#000', weight: 5, fillColor: '#00ff00', fillOpacity: 1 })
    .addTo(map).bindPopup('YOU ARE HERE', { permanent: true, className: 'you-popup' }).openPopup();
  playerMarker.getElement().style.filter = 'drop-shadow(0 0 20px #00ff00)';
  try {
    const res = await fetch(`${API_BASE}/locations`);
    if (!res.ok) throw new Error('Locations fetch failed');
    const locations = await res.json();
    locations.forEach(loc => {
      const color = loc.rarity === 'legendary' ? '#ffff00' : loc.rarity === 'epic' ? '#ff6200' : loc.rarity === 'rare' ? '#00ffff' : '#00ff00';
      const m = L.circleMarker([loc.lat, loc.lng], { radius: 14, color: '#000', weight: 4, fillColor: color, fillOpacity: 0.9 })
        .bindPopup(`<b style="color:#0f0">${loc.n}</b><br><span class="rar ${loc.rarity || 'common'}">${(loc.rarity || 'common').toUpperCase()}</span><br>Level ${loc.lvl}`)
        .on('click', () => claimLoot(loc))
        .addTo(map);
      markers[loc.n] = m;
    });
  } catch (e) { console.error(e); alert('Failed to load locations—add to server.js'); }
  if ('geolocation' in navigator) {
    watchId = navigator.geolocation.watchPosition(pos => {
      player.lat = pos.coords.latitude;
      player.lng = pos.coords.longitude;
      playerMarker.setLatLng([player.lat, player.lng]);
      map.panTo([player.lat, player.lng]);
    }, err => console.error('GPS error:', err), { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
  }
}

// Mint stub
async function mintLegendaryNFT(itemName) {
  alert(`MINTING: ${itemName} (Backend handles)`);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  updateUI();
});
</script>
</body>
</html>
