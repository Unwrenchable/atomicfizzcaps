<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Atomic Fizz">
<meta name="theme-color" content="#001a00">
<title>Atomic Fizz ¬∑ Vault 77 ‚Äì 50 LOCATIONS MOBILE</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400;700&display=swap');
* {margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html, body {height:100%;overflow-y:auto;background:#000;color:#0f0;font-family:'Share Tech Mono',monospace;-webkit-user-select:none;user-select:none;}
.term {flex:1;display:flex;flex-direction:column;background:#001a00;border:3px solid #0f0;box-shadow:0 0 40px #0f0;padding:15px;border-radius:12px;position:relative;text-align:center;min-height:0;overflow-y:auto;max-height:100vh;}
.term::before {content:"VAULT 77 ¬∑ ATOMIC FIZZ ¬∑ 50 LOCATIONS v3.3 ‚úÖ";position:absolute;top:-15px;left:10px;background:#000;padding:0 15px;font-size:12px;letter-spacing:3px;}
h1 {font-size:clamp(2.5rem,6vw,4rem);margin:15px 0;text-shadow:0 0 25px #0f0;animation:f 2s infinite;}
button {background:transparent;border:2px solid #0f0;color:#0f0;padding:12px 25px;font-size:clamp(1.2rem,4vw,1.6rem);margin:10px 5px;cursor:pointer;box-shadow:0 0 25px #0f0;transition:.2s;letter-spacing:2px;border-radius:8px;min-height:50px;display:flex;align-items:center;justify-content:center;touch-action:manipulation;}
button:active {background:#0f0;color:#000;box-shadow:0 0 50px #0f0;transform:scale(0.95);}
button:disabled {opacity:0.4;}
.status {font-size:clamp(1.2rem,3.5vw,1.6rem);margin:15px 0;}
.char {background:rgba(0,30,0,0.8);padding:12px;margin:15px 0;border-left:4px solid #0f0;border-radius:8px;font-size:clamp(0.9rem,2.5vw,1.1rem);}
.level-bar, .health-bar {background:#111;border:1px solid #ff9500;padding:8px;margin:8px 0;border-radius:6px;}
.level-fill, .health-fill {height:20px;background:linear-gradient(90deg,#ff9500,#ffff00,#0f0);transition:width .3s;border-radius:3px;}
.health-fill {background:linear-gradient(90deg,#f66,#ff9500,#0f0);}
.gear-item {display:flex;justify-content:space-between;align-items:center;background:#111;padding:8px;margin:5px 0;border:1px solid #ff6200;border-radius:6px;font-size:0.85rem;}
.durability-bar {flex:1;margin:0 8px;max-width:120px;}
.durability-fill {height:12px;background:linear-gradient(90deg,#f66,#ff6200,#0f0);border-radius:2px;transition:width .3s;}
#mapContainer {flex:1;display:none;min-height:400px;position:relative;margin:10px 0;}
#map {height:100%;border:3px solid #0f0;box-shadow:0 0 30px #0f0;border-radius:12px;}
#nearby {position:absolute;top:10px;left:10px;right:10px;background:rgba(0,0,0,0.9);padding:12px;border:2px solid #ff9500;border-radius:8px;color:#ff9500;font-size:clamp(0.8rem,2vw,1rem);max-height:120px;overflow-y:auto;z-index:1000;}
.overlay {display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;color:#ff9500;padding:20px;}
.cratebox {width:280px;height:280px;max-width:90vw;max-height:90vh;background:#111;border:5px solid #ff6200;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:clamp(3rem,12vw,5rem);animation:s 0.8s infinite;}
.raid-alert {background:#330000;border:4px solid #f66;padding:25px;border-radius:12px;text-align:center;max-width:90vw;max-height:80vh;overflow-y:auto;}
.combat-log {background:#111;padding:12px;margin:12px 0;border:1px solid #f66;border-radius:6px;max-height:150px;overflow-y:auto;font-size:0.85rem;line-height:1.3;}
.level-up {background:#001a00 !important;border:3px solid #0f0 !important;color:#0f0 !important;animation:levelGlow 1.5s infinite;}
.death-screen {background:#000;border:5px solid #f66;padding:30px;border-radius:15px;text-align:center;max-width:90vw;}
.stimpak-btn {background:#0f0 !important;color:#000 !important;border-color:#0f0 !important;}
@keyframes f {0%,100%{opacity:1}50%{opacity:0.6}}
@keyframes s {0%,100%{transform:translate(0)}25%{transform:translate(-8px,8px)rotate(-3deg)}75%{transform:translate(8px,-8px)rotate(3deg)}}
@keyframes levelGlow {0%,100%{box-shadow:0 0 30px #0f0}50%{box-shadow:0 0 60px #0f0,0 0 100px #ffff00}}
.leaflet-touch .leaflet-bar a {width:36px !important;height:36px !important;line-height:36px !important;}
.leaflet-touch .leaflet-control-zoom-in, .leaflet-touch .leaflet-control-zoom-out {font-size:18px !important;}
@media (max-width: 768px) {.term {padding:10px;margin:5px;border-radius:8px;border-width:2px;}}
</style>
</head>
<body>
<div class="term" id="mainContainer">
<h1>ATOMIC FIZZ</h1>
<p style="font-size:clamp(1.2rem,4vw,2rem);margin:15px 0;">‚öîÔ∏è 50 FALLOUT LOCATIONS + LEVELING</p>
<div style="background:rgba(0,40,0,0.7);padding:15px;margin:20px 0;border-left:4px solid #0f0;border-radius:8px;line-height:1.4;font-size:clamp(0.9rem,2.8vw,1.2rem);">
üéØ <b>50 LOCATIONS</b> ‚Üí üí∞ LOOT ‚Üí ‚öîÔ∏è FIGHT ‚Üí ‚≠ê LEVEL UP ‚Üí üí™ STRONGER
</div>
<button id="connectBtn">CONNECT WALLET</button>
<div class="status" id="status">Status: <span style="color:#f66;">NOT CONNECTED</span></div>
<div class="char" id="character" style="display:none;">
Wastelander: <span id="name">???</span> ‚Ä¢
<span id="levelDisplay" class="level-up">LVL <span id="lvl">1</span></span> ‚Ä¢
XP: <span id="xpText">0</span>/<span id="xpMax">100</span>
<div class="level-bar">
<div class="level-fill" id="xpBar" style="width:0%;"></div>
</div>
<div class="health-bar">
HP: <span id="hpText">100/100</span>
<div class="health-fill" id="hpBar" style="width:100%;"></div>
</div>
CAPS: <span id="caps">0</span>
</div>
<div class="gear-inventory" id="gearInventory" style="display:none;background:rgba(0,30,0,0.8);padding:15px;margin:15px 0;border-left:4px solid #ff6200;border-radius:8px;">
<h3 style="color:#ff6200;">‚öîÔ∏è GEAR</h3>
<div id="gearList"></div>
</div>
<div class="stimpak-shop" id="stimpakShop" style="display:none;background:rgba(0,30,0,0.8);padding:15px;margin:15px 0;border-left:4px solid #0f0;border-radius:8px;">
<h3 style="color:#0f0;">üíâ STIMPAK SHOP</h3>
<div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
<button id="buyCommonStimpak" style="flex:1;min-width:120px;">Stimpak<br><span style="font-size:0.8em;">100 CAPS</span></button>
<button id="buyRareStimpak" style="flex:1;min-width:120px;">Super Stimpak<br><span style="font-size:0.8em;">500 CAPS</span></button>
</div>
<div id="stimpakInventory" style="margin-top:10px;"></div>
</div>
<button id="gpsBtn" disabled style="background:linear-gradient(45deg,#ff6200,#ff9500);border-color:#ff6200;color:#000;font-weight:700;">üéØ 50 LOCATION SCANNER</button>
<div id="mapContainer" style="display:none;"><div id="map"></div><div id="nearby"></div></div>
<button id="backBtn" onclick="backToMain()" style="display:none;background:linear-gradient(45deg,#f66,#ff9500);border-color:#f66;color:#000;font-weight:700;">üè† BACK TO TERMINAL</button>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="lootOverlay">
<div class="cratebox">üí∞ LOOT!</div>
<h2 id="lootResult" style="margin:20px;font-size:clamp(1.2rem,5vw,2rem);">?</h2>
<button onclick="closeLoot()" style="margin-top:20px;">CONTINUE</button>
</div>

<div class="overlay" id="raidOverlay">
<div class="raid-alert">
<h2 id="enemyName" style="font-size:clamp(1.5rem,6vw,2.5rem);">üíÄ RAIDERS!</h2>
<p id="enemyStats" style="color:#ff9500;margin:10px 0;">25 ATK ‚Ä¢ 50 HP ‚Ä¢ 15 DEF</p>
<div class="combat-log" id="combatLog"></div>
<div style="display:flex;gap:15px;justify-content:center;margin:20px 0;flex-wrap:wrap;">
<button id="fightBtn" style="background:#0f0;color:#000;border-color:#0f0;min-width:120px;">‚öîÔ∏è FIGHT</button>
<button id="fleeBtn" style="border-color:#f66;color:#f66;min-width:120px;">üèÉ FLEE</button>
</div>
</div>
</div>

<div class="overlay" id="deathOverlay">
<div class="death-screen">
<div style="font-size:clamp(4rem,15vw,8rem);margin:15px;">‚ò†Ô∏è</div>
<h2 style="font-size:clamp(1.5rem,6vw,2.5rem);">YOU DIED</h2>
<p id="deathMessage" style="margin:15px 0;font-size:clamp(1rem,4vw,1.3rem);">Raiders destroyed you...</p>
<button class="stimpak-btn" id="reviveBtn" style="min-width:200px;font-size:1.3rem;">üíâ REVIVE WITH STIMPAK</button>
<p style="color:#f66;margin-top:15px;font-size:clamp(0.9rem,3vw,1.1rem);">No Stimpaks = PERMANENT DEATH</p>
</div>
</div>

<div class="overlay" id="levelUpOverlay">
<div style="background:#001a00;border:5px solid #0f0;padding:30px;border-radius:15px;text-align:center;max-width:90vw;">
<div style="font-size:clamp(4rem,15vw,8rem);margin:15px;">‚≠ê</div>
<h2 style="color:#0f0;font-size:clamp(1.5rem,6vw,2.5rem);">LEVEL UP!</h2>
<p style="font-size:clamp(1.2rem,5vw,2rem);margin:15px 0;">LVL <span id="newLevel">2</span></p>
<p style="color:#ff9500;font-size:clamp(1rem,4vw,1.3rem);">+20 HP ‚Ä¢ +5 ATK ‚Ä¢ +3 DEF</p>
<button onclick="closeLevelUp()" style="margin-top:20px;min-width:200px;">üí™ CONTINUE WASTELAND</button>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let wallet, map, userMarker, spotMarkers = [], claimed = new Set(), playerState = {
  level: 1, xp: 0, xpToNext: 100, maxHp: 100, hp: 100, gear: [], stimpaks: [], caps: 0
}, currentRaid = null;

const falloutSpots = [
  {n:"üõ§Ô∏è Sloan Station",lat:35.94361,lng:-115.21722},
  {n:"‚õèÔ∏è Quarry Junction",lat:35.9200,lng:-115.1800},
  {n:"üè™ 188 Trading Post",lat:35.9500,lng:-115.2000},
  {n:"üì° Black Mountain",lat:35.9310,lng:-115.0440},
  {n:"üé∞ New Vegas Strip",lat:36.112740,lng:-115.174301},
  {n:"üè® Lucky 38",lat:36.147247,lng:-115.156029},
  {n:"üèöÔ∏è Freeside",lat:36.170719,lng:-115.143929},
  {n:"üç∫ Goodsprings",lat:35.8324,lng:-115.4320},
  {n:"üé≤ Primm",lat:35.6145,lng:-115.3845},
  {n:"‚ö° Hoover Dam",lat:36.016045,lng:-114.737839},
  {n:"üèõÔ∏è Vault 34",lat:36.1750,lng:-114.7500},
  {n:"ü¶é Jacobstown",lat:36.3000,lng:-115.6500},
  {n:"‚òÄÔ∏è Helios One",lat:35.7580,lng:-114.9530},
  {n:"üëΩ Novac",lat:37.6447,lng:-115.7461},
  {n:"üè™ Nipton Trading",lat:35.46667,lng:-115.27222},
  {n:"‚úàÔ∏è McCarran Airport",lat:36.0801,lng:-115.1522},
  {n:"üõ©Ô∏è Nellis AFB",lat:36.2361,lng:-115.0342},
  {n:"üè® Ultra-Luxe",lat:36.0972,lng:-115.1787},
  {n:"üî• Gomorrah",lat:36.1100,lng:-115.1720},
  {n:"‚ö° Silver Rush",lat:36.1498,lng:-115.1390},
  {n:"üç∏ Atomic Wrangler",lat:36.1499,lng:-115.1383},
  {n:"üöÄ REPCONN Test",lat:36.0360,lng:-115.0880},
  {n:"üëª Nelson Ghost",lat:35.4189,lng:-114.7133},
  {n:"üèîÔ∏è Mt. Charleston",lat:36.2650,lng:-115.6500},
  {n:"üèõÔ∏è Vault 21",lat:36.1311,lng:-115.1564},
  {n:"ü•§ Sunset Sarsaparilla",lat:36.0000,lng:-115.2000},
  {n:"‚õ™ Camp Searchlight",lat:35.4600,lng:-114.9200},
  {n:"üé™ Vikki & Vance",lat:35.6150,lng:-115.3850},
  {n:"üåµ Red Rock Canyon",lat:36.13514,lng:-115.4283},
  {n:"üö§ Callville Bay",lat:36.14400,lng:-114.72200},
  {n:"üõ§Ô∏è Jean Airport",lat:35.7677,lng:-115.3245},
  {n:"üî¶ Searchlight",lat:35.46434,lng:-114.91844},
  {n:"üè® Boulder City",lat:35.97750,lng:-114.83639},
  {n:"üèöÔ∏è Rhyolite Ghost",lat:36.9033,lng:-116.8283},
  {n:"‚òÄÔ∏è Ivanpah Solar",lat:35.2000,lng:-115.4667},
  {n:"üö¢ Cottonwood Cove",lat:35.9990,lng:-114.5000},
  {n:"üèöÔ∏è Bonnie Springs",lat:36.06007,lng:-115.45027},
  {n:"üèõÔ∏è REPCONN HQ",lat:36.0500,lng:-115.1000},
  {n:"üöö Griffin Caravan",lat:35.9000,lng:-115.2500},
  {n:"üöì Nevada Patrol",lat:35.9500,lng:-115.1500},
  {n:"‚òÄÔ∏è Nellis Solar",lat:36.2460,lng:-115.0320},
  {n:"üï≥Ô∏è Dead Wind",lat:35.8000,lng:-115.4000},
  {n:"üèîÔ∏è Mesquite Mtn",lat:35.8500,lng:-115.9500},
  {n:"üåã Devil's Gullet",lat:35.7000,lng:-115.3000},
  {n:"üè® Whiskey Pete's",lat:35.6167,lng:-115.3900},
  {n:"üè® Primm Valley",lat:35.6160,lng:-115.3900},
  {n:"ü•§ Coca Cola",lat:36.1025,lng:-115.1738},
  {n:"üèõÔ∏è Mormon Fort",lat:36.1694,lng:-115.1305},
  {n:"üîß HELIOS Entrance",lat:35.7600,lng:-114.9500}
];

const enemyTypes = [
  {name:"üíÄ Fiends", atk:15, hp:40, def:10, caps:25, xp:30, emoji:"üíÄ"},
  {name:"‚öîÔ∏è Raiders", atk:20, hp:50, def:12, caps:35, xp:40, emoji:"‚öîÔ∏è"},
  {name:"üî• Vipers", atk:18, hp:45, def:8, caps:30, xp:35, emoji:"üî•"},
  {name:"ü¶é Jackals", atk:12, hp:35, def:6, caps:20, xp:25, emoji:"ü¶é"},
  {name:"üíÄ Super Mutant", atk:35, hp:80, def:25, caps:75, xp:80, emoji:"üíÄ"}
];

const levelRequirements = [0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200, 4000];
function getLevelForXp(xp) {for(let i=levelRequirements.length-1;i>=0;i--)if(xp>=levelRequirements[i])return i;return 1;}
function getXpForLevel(level) {return levelRequirements[level]||4000;}

function updateUI() {
  document.getElementById("lvl").textContent = playerState.level;
  document.getElementById("xpText").textContent = playerState.xp;
  document.getElementById("xpMax").textContent = playerState.xpToNext;
  document.getElementById("xpBar").style.width = `${Math.min(100, (playerState.xp/getXpForLevel(playerState.level+1))*100)}%`;
  document.getElementById("hpText").textContent = `${playerState.hp}/${playerState.maxHp}`;
  document.getElementById("hpBar").style.width = `${(playerState.hp/playerState.maxHp)*100}%`;
  document.getElementById("caps").textContent = playerState.caps||0;
  
  document.getElementById("gearList").innerHTML = playerState.gear?.map(g=>`
    <div class="gear-item">
      <span>${g.name} ${g.atk?`+${g.atk}ATK`:''} ${g.def?`+${g.def}DEF`:''}</span>
      <div class="durability-bar"><div class="durability-fill" style="width:${g.durability}%"></div></div>
      <span>${g.durability}%</span>
    </div>
  `).join('') || '<p style="color:#f66;">NO GEAR ‚Äì LOOT NOW!</p>';
  
  document.getElementById("stimpakInventory").innerHTML = playerState.stimpaks?.map(s=>
    `<div style="color:#0f0;">üíâ ${s.name}</div>`
  ).join('') || '<p style="color:#f66;">NO STIMPAKS</p>';
}

function loadPlayerState() {
  playerState = {level:1,xp:0,xpToNext:100,maxHp:100,hp:100,gear:[],stimpaks:[],caps:0};
  updateUI();
}

function awardXp(amount, source) {
  playerState.xp += amount;
  const oldLevel = playerState.level;
  playerState.level = getLevelForXp(playerState.xp);
  playerState.xpToNext = getXpForLevel(playerState.level+1) - playerState.xp;
  
  if(playerState.level > oldLevel) {
    playerState.maxHp += 20 * (playerState.level - oldLevel);
    playerState.hp = playerState.maxHp;
    playerState.gear?.forEach(g => {
      if(g.atk) g.atk += 2 * (playerState.level - oldLevel);
      if(g.def) g.def += 1 * (playerState.level - oldLevel);
    });
    document.getElementById("newLevel").textContent = playerState.level;
    document.getElementById("levelUpOverlay").style.display = "flex";
    setTimeout(()=>document.getElementById("levelUpOverlay").style.display="none", 3500);
  }
  updateUI();
}

document.getElementById("connectBtn").onclick = () => {
  wallet = "MOBILE_" + Date.now();
  document.getElementById("status").innerHTML = `Status: <span style="color:#0f0;">TEST MODE ACTIVE</span>`;
  document.getElementById("connectBtn").textContent = "‚úÖ ACTIVE";
  document.getElementById("connectBtn").disabled = true;
  document.getElementById("gpsBtn").disabled = false;
  document.getElementById("character").style.display = "block";
  document.getElementById("name").textContent = "WASTELANDER";
  document.getElementById("gearInventory").style.display = "block";
  document.getElementById("stimpakShop").style.display = "block";
  loadPlayerState();
  alert(`‚úÖ TEST MODE ACTIVE!\nüéØ ${falloutSpots.length} FALLOUT LOCATIONS LOADED!`);
};

document.getElementById("buyCommonStimpak").onclick = () => {
  if(playerState.caps >= 100) {
    playerState.caps -= 100;
    playerState.stimpaks.push({name:"Stimpak"});
    updateUI();
    alert("üíâ Stimpak purchased!");
  } else alert("‚ùå Need 100 CAPS");
};

document.getElementById("buyRareStimpak").onclick = () => {
  if(playerState.caps >= 500) {
    playerState.caps -= 500;
    playerState.stimpaks.push({name:"Super Stimpak"});
    updateUI();
    alert("üíâ Super Stimpak purchased!");
  } else alert("‚ùå Need 500 CAPS");
};

function startCombat(spotName) {
  currentRaid = {spot:spotName,enemy:{...enemyTypes[Math.floor(Math.random()*enemyTypes.length)]},turn:0};
  document.getElementById("enemyName").textContent = `${currentRaid.enemy.emoji} ${currentRaid.enemy.name}`;
  document.getElementById("enemyStats").textContent = `${currentRaid.enemy.atk} ATK ‚Ä¢ ${currentRaid.enemy.hp} HP ‚Ä¢ ${currentRaid.enemy.def} DEF`;
  document.getElementById("combatLog").innerHTML = `<div style="color:#0f0;">‚öîÔ∏è Combat at ${spotName}!</div>`;
  document.getElementById("raidOverlay").style.display = "flex";
  
  const combatInterval = setInterval(() => {
    if(!currentRaid || currentRaid.won!==undefined) {clearInterval(combatInterval);return;}
    
    currentRaid.turn++;
    const log = document.getElementById("combatLog");
    const levelMult = 1 + (playerState.level-1)*0.15;
    const playerAtk = (10 + levelMult*5) + (playerState.gear?.reduce((s,g)=>s+(g.atk||0),0)||0);
    const playerDef = (5 + levelMult*2) + (playerState.gear?.reduce((s,g)=>s+(g.def||0),0)||0);
    
    const pDamage = Math.max(1, playerAtk - currentRaid.enemy.def + Math.random()*15);
    currentRaid.enemy.hp -= pDamage;
    log.innerHTML += `<div style="color:#0f0;">[LVL${playerState.level}] ${pDamage} damage!</div>`;
    
    if(currentRaid.enemy.hp <= 0) {
      currentRaid.won = true;
      awardXp(currentRaid.enemy.xp, "Combat");
      log.innerHTML += `<div style="color:#0f0;font-size:1.1rem;">‚úÖ VICTORY! +${currentRaid.enemy.xp} XP</div>`;
      setTimeout(()=>endCombat(true), 1500);
      return;
    }
    
    const eDamage = Math.max(1, currentRaid.enemy.atk - playerDef + Math.random()*10);
    playerState.hp -= eDamage;
    log.innerHTML += `<div style="color:#f66;">Enemy hits ${eDamage}!</div>`;
    
    playerState.gear?.forEach(g => {if(Math.random()<0.25) g.durability = Math.max(0,g.durability-8);});
    
    if(playerState.hp <= 0) {
      currentRaid.won = false;
      log.innerHTML += `<div style="color:#f66;font-size:1.1rem;">‚ò†Ô∏è DEFEAT!</div>`;
      setTimeout(()=>endCombat(false), 1000);
      return;
    }
    
    updateUI();
    log.scrollTop = log.scrollHeight;
  }, 1600);
}

function endCombat(won) {
  setTimeout(() => {
    document.getElementById("raidOverlay").style.display = "none";
    if(won) {
      claimed.add(currentRaid.spot);
      const idx = spotMarkers.findIndex(m=>m.spotName===currentRaid.spot);
      if(idx>-1 && map) {map.removeLayer(spotMarkers[idx]);spotMarkers.splice(idx,1);}
      playerState.caps += currentRaid.enemy.caps;
      updateUI();
    } else {
      document.getElementById("deathOverlay").style.display = "flex";
      document.getElementById("deathMessage").textContent = `${currentRaid.enemy.name} destroyed you...`;
    }
    currentRaid = null;
  }, 500);
}

document.getElementById("fightBtn").onclick = () => {
  document.getElementById("fightBtn").disabled = true;
  document.getElementById("fightBtn").textContent = "‚öîÔ∏è FIGHTING...";
  if(currentRaid) startCombat(currentRaid.spot);
};

document.getElementById("fleeBtn").onclick = () => {
  document.getElementById("raidOverlay").style.display = "none";
  currentRaid = null;
  alert("üèÉ Fled from combat!");
};

document.getElementById("reviveBtn").onclick = () => {
  if(playerState.stimpaks?.length > 0) {
    const stimpak = playerState.stimpaks.shift();
    playerState.hp = stimpak.name.includes('Super') ? playerState.maxHp : Math.min(playerState.maxHp, playerState.hp + 60);
    playerState.gear?.forEach(g => g.durability = Math.min(100, g.durability + 20));
    document.getElementById("deathOverlay").style.display = "none";
    updateUI();
    alert(`üíâ REVIVED with ${stimpak.name}!`);
  } else alert("‚ùå NO STIMPAKS!");
};

function closeLevelUp() {document.getElementById("levelUpOverlay").style.display="none";}
function closeLoot() {document.getElementById("lootOverlay").style.display="none";}

function claimLoot(spotName) {
  if(claimed.has(spotName)) return;
  if(Math.random() < 0.35) {startCombat(spotName);return;}
  
  const xpGain = 15 + playerState.level*5 + Math.random()*10;
  awardXp(xpGain, "Loot");
  const capsGain = 10 + Math.random()*20;
  playerState.caps += capsGain;
  if(Math.random() < 0.4) {
    const gearTypes = [
      {name:"10mm Pistol", atk:8, def:0},
      {name:"Leather Armor", atk:0, def:6},
      {name:"Hunting Rifle", atk:12, def:0},
      {name:"Metal Armor", atk:0, def:10}
    ];
    const gear = gearTypes[Math.floor(Math.random()*gearTypes.length)];
    playerState.gear.push({...gear, durability: 75 + Math.random()*25});
  }
  
  claimed.add(spotName);
  document.getElementById("lootResult").innerHTML = `+${Math.round(xpGain)} XP<br>+${Math.round(capsGain)} CAPS`;
  document.getElementById("lootOverlay").style.display = "flex";
  updateUI();
  
  const idx = spotMarkers.findIndex(m=>m.spotName===spotName);
  if(idx>-1 && map) {map.removeLayer(spotMarkers[idx]);spotMarkers.splice(idx,1);}
}

function backToMain() {
  document.getElementById("mapContainer").style.display = "none";
  document.getElementById("backBtn").style.display = "none";
  document.getElementById("mainContainer").style.display = "flex";
  if(map) {map.remove(); map = null;}
}

document.getElementById("gpsBtn").onclick = () => {
  document.getElementById("mainContainer").style.display = "none";
  document.getElementById("mapContainer").style.display = "block";
  document.getElementById("backBtn").style.display = "block";
  
  map = L.map('map', {zoomControl:true,attributionControl:false}).setView([36.1146,-115.1728],9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:''}).addTo(map);
  
  userMarker = L.circleMarker([36.1146,-115.1728],{
    radius:12,color:'#0f0',fillColor:'#0f0',fillOpacity:0.8
  }).addTo(map).bindPopup("üü¢ YOU ARE HERE");
  
  spotMarkers = [];
  falloutSpots.forEach(spot => {
    if(claimed.has(spot.n)) return;
    const marker = L.circleMarker([spot.lat,spot.lng],{
      radius:8,color:'#ff6200',fillColor:'#ff6200',fillOpacity:0.8,weight:2
    })
    .bindPopup(`<b>${spot.n}</b><br>üëÜ Tap to LOOT!`)
    .addTo(map)
    .on('click', ()=>{ 
      map.setView([spot.lat,spot.lng],16); 
      claimLoot(spot.n);
    });
    marker.spotName = spot.n;
    spotMarkers.push(marker);
  });
  
  if(navigator.geolocation) {
    navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      userMarker.setLatLng([lat,lng]);
      map.setView([lat,lng],14);
      let near = "";
      falloutSpots.forEach(spot=>{
        if(claimed.has(spot.n)) return;
        const dist = map.distance([lat,lng],[spot.lat,spot.lng]);
        if(dist < 60) claimLoot(spot.n);
        else if(dist < 300) near += `${spot.n} ‚Äì ${Math.round(dist)}m<br>`;
      });
      document.getElementById("nearby").innerHTML = near ? "üéØ NEARBY LOOT:<br>" + near : "üö∂ Walk closer to loot!";
    }, err => {
      document.getElementById("nearby").innerHTML = `<span style="color:#ff9500;">üìç GPS OFF - Tap markers manually!</span>`;
    }, {enableHighAccuracy:true,timeout:10000,maximumAge:10000});
  } else {
    document.getElementById("nearby").innerHTML = `<span style="color:#ff9500;">üìç Tap orange markers to LOOT!</span>`;
  }
  
  setTimeout(() => map.invalidateSize(), 500);
  alert(`üéØ RADIATION SCANNER ACTIVE!\n‚úÖ ${spotMarkers.length} LOOT SPOTS\nüü¢=You | üü†=Loot\nüëÜ TAP ORANGE DOTS!`);
};

console.log(`üéØ ATOMIC FIZZ v3.3 LOADED - ${falloutSpots.length} LOCATIONS READY!`);
</script>
</body>
</html>
